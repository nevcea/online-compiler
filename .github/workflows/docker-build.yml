name: Docker Build Test

on:
    push:
        branches: [main, master]
        paths:
            - 'backend/Dockerfile'
            - 'docker-compose.yml'
            - 'backend/**'
    pull_request:
        branches: [main, master]
        paths:
            - 'backend/Dockerfile'
            - 'docker-compose.yml'
            - 'backend/**'

jobs:
    docker-build:
        name: Docker Build and Test
        permissions:
            contents: read
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Create .env file if not exists
              run: |
                  if [ ! -f .env ]; then
                      touch .env
                      echo "# Environment variables (optional)" >> .env
                  fi

            - name: Build Docker image
              run: |
                  docker compose build

            - name: Test Docker Compose
              run: |
                  docker compose up -d
                  sleep 5
                  docker compose ps
                  docker compose down
